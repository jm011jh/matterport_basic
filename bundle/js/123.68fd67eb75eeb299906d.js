/*! For license information please see 123.68fd67eb75eeb299906d.js.LICENSE.txt */
"use strict";(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[123],{25434:(e,i,t)=>{t.d(i,{Z:()=>s,u:()=>n});var a=t(89103);class n extends a.QB{constructor(e,i,t){super(),this.name=e,this.version=i,this.loadTime=t}}class s{constructor(){this.handlers=[{msgType:n,func:(e,i,t)=>{e.track("plugin_loaded",{name:i.name,version:i.version,time:i.loadTime})}}]}}},41122:(e,i,t)=>{t.d(i,{My:()=>r,W:()=>d,YB:()=>s,ho:()=>n,nq:()=>o,u3:()=>l});var a=t(55141);class n extends a.u{constructor(e,i=!1){super(),this.payload={exclude:e||[],hard:i}}}n.id="PLUGIN_RESET_ALL";class s extends a.u{constructor(e,i,t,a){super(),this.payload={name:e,config:i,configMeta:t,permissions:a||{}}}}s.id="PLUGIN_RELOAD";class o extends a.u{constructor(e,i,t,a){super(),this.payload={name:e,config:i,configMeta:t,permissions:a||{}}}}o.id="PLUGIN_LOAD";class l extends a.u{constructor(e){super(),this.payload={name:e}}}l.id="PLUGIN_UNLOAD";class r extends a.u{constructor(e,i){super(),this.payload={operation:e,callback:i}}}r.id="PLUGIN_CONFIG_FETCH_DATA";class d extends a.u{constructor(e,i){super(),this.payload={attachmentId:e,pluginId:i}}}d.id="ATTACHMENT_ASSOCIATE_WITH_PLUGIN";class c extends a.u{constructor(e,i){super(),this.payload={attachmentId:e,pluginId:i}}}c.id="ATTACHMENT_DISSOCIATE_FROM_PLUGIN"},31809:(e,i,t)=>{t.d(i,{kR:()=>y,nT:()=>u});var a=t(84710),n=t(56413),s=t(10843),o=t(43591),l=t(65746),r=t(64491),d=t(96540),c=t(40961);const h=new s.Ay("plugin-ui-data");var u;!function(e){e.OVERLAY="overlay",e.TAG_PANEL="tag-panel",e.TAG_HEADER="tag-header",e.TAG_OVERLAY="tag-overlay"}(u||(u={}));function g(e,i){return(0,d.createElement)("span",{className:e+"-slot-wrapper",ref:e=>null==e?void 0:e.appendChild(i),key:e})}class p{constructor(e,i="closed",t=document.createElement("div"),a=g(e,t),n=null){this.slotType=e,this.shadowRootMode=i,this.rawNode=t,this.reactNode=a,this.shadowRoot=n}getOrCreateShadowRoot(){return this.shadowRoot||(this.shadowRoot=this.rawNode.attachShadow({mode:this.shadowRootMode})),this.shadowRoot}hasShadowRoot(){return!!this.shadowRoot}clear(){return(0,c.unmountComponentAtNode)(this.rawNode),this.rawNode.remove(),this.rawNode=document.createElement("div"),this.shadowRoot=null,this.reactNode=g(this.slotType,this.rawNode),this}}class y extends a.B{constructor(e,i="closed"){var t;super(),this.parentMainDiv=e,this.shadowRootMode=i,this.name="plugin-ui-data",this.separator="Â¦",this.overlayRoot=document.createElement("div"),this.testSet=new Set,this.overlayRootAppended=!1,this.pluginOverlayElements=new n.E,this.pluginEmbeddedElements={[u.TAG_OVERLAY]:{},[u.TAG_PANEL]:{},[u.TAG_HEADER]:{},[u.OVERLAY]:{}},this.subs=[],this.mobile=(0,r.Fr)(),this.initOverlayRoot=()=>{this.overlayRootAppended||(this.parentMainDiv.appendChild(this.overlayRoot),this.overlayRootAppended=!0,this.grid=l.dn.init({column:16,margin:0,float:!0,animate:!1,row:16,alwaysShowResizeHandle:!0,resizable:{handles:"se, sw"},children:[{x:0,y:0,w:4,h:2,locked:!0,noMove:!0,noResize:!0}]},this.overlayRoot),this.resizeObserver=new o.A(this.resizeHandler),this.resizeObserver.observe(this.watchedElement))},this.watchedElement=null!==(t=this.parentMainDiv.getElementsByTagName("canvas")[0])&&void 0!==t?t:this.parentMainDiv,h.debug("PluginUIData loaded"),this.overlayRoot.classList.add("plugin-root-element","grid-stack"),this.initOverlayListeners(),this.resizeHandler=this.handleResize.bind(this)}getEmbeddable(e){const i=this.pluginEmbeddedElements[e];return Object.values(i).filter((e=>e.hasShadowRoot())).map((e=>e.reactNode))}handleResize(e=[]){if(!e.length)return;const i=Math.floor(this.overlayRoot.clientHeight/16);this.grid.cellHeight(i),this.overlayRoot.style.width=`${this.watchedElement.clientWidth}px`}registerOverlay(e,i,t){this.pluginOverlayElements.set(e,i),t&&(this.grid?this.grid.addWidget(i):h.warn("tried to register an overlay, but gridstack not initialized yet"))}createEmbeddedUi(e,i){return this.pluginEmbeddedElements[i][e]=new p(i,this.shadowRootMode)}getOrCreateEmbeddedUi(e,i,t){let a=this.pluginEmbeddedElements[i][e];return a||(a=this.createEmbeddedUi(e,i)),a.rawNode.classList.add(e),t||a.rawNode.classList.add("constrain-height"),a}createOverlay(e,i=!1){const t=document.createElement("div");return t.classList.add("plugin-overlay"),t.classList.add(e),i&&(t.classList.add("grid-stack-item"),t.setAttribute("gs-min-w",this.mobile?"2":"1"),t.setAttribute("gs-min-h",this.mobile?"2":"1")),this.registerOverlay(e,t,i),t}replaceOrCreateOverlay(e,i){let t=this.pluginOverlayElements.get(e);if(t&&(t.remove(),this.grid?this.grid.removeWidget(t):h.warn("[replaceOrCreate] tried to remove an overlay, but gridstack not initialized yet")),t=this.createOverlay(e,i),i){const e=document.createElement("span");return e.classList.add("grid-stack-item-content"),t.appendChild(e),e}return t}createRoots(e,i){return{[u.OVERLAY]:this.createOverlayRoot(e,i),[u.TAG_PANEL]:this.createRoot(e,u.TAG_PANEL),[u.TAG_HEADER]:this.createRoot(e,u.TAG_HEADER),[u.TAG_OVERLAY]:this.createRoot(e,u.TAG_OVERLAY,{expandOverlay:!0})}}createRoot(e,i,{expandOverlay:t=!1}={}){return this.getOrCreateEmbeddedUi(e,i,t)}createOverlayRoot(e,i){const t=this.replaceOrCreateOverlay(e,i.canPlaceInGrid);return new p(u.OVERLAY,this.shadowRootMode,t)}initOverlayListeners(){h.info("init plugin UI overlay"),this.subs.push(this.pluginOverlayElements.onElementChanged({onAdded:(e,i)=>{h.debug("added plugin overlay",i),this.initOverlayRoot(),e&&this.overlayRoot.appendChild(e)},onRemoved:(e,i)=>{h.debug("removed plugin overlay",i),e&&e.remove()}}))}disposeByKey(e){this.pluginOverlayElements.delete(e),Object.values(this.pluginEmbeddedElements).forEach((i=>{var t;null===(t=i[e])||void 0===t||t.clear()}))}dispose(){this.pluginOverlayElements.forEach(((e,i)=>{this.disposeByKey(i)})),this.subs.forEach((e=>e.cancel())),this.subs=[],this.grid.destroy(),this.resizeObserver.disconnect(),this.overlayRootAppended=!1,this.overlayRoot.remove()}}},69504:(e,i,t)=>{t.r(i),t.d(i,{PluginPermissionLevel:()=>n,default:()=>P});var a,n,s=t(90082),o=t(71687),l=t(30877),r=t(75578),d=t(31809),c=t(32948),h=t(56846),u=t(41122),g=t(25434),p=t(91593);!function(e){e[e.FetchAnonymous=1]="FetchAnonymous",e[e.FetchAsUser=2]="FetchAsUser",e[e.AnyFetch=3]="AnyFetch",e[e.LocalData=4]="LocalData",e[e.EarlyLoad=268435456]="EarlyLoad",e[e.DisableSES=2147483648]="DisableSES"}(a||(a={})),function(e){e[e.Locked=0]="Locked",e[e.Default=4]="Default",e[e.DefaultEarlyLoad=268435462]="DefaultEarlyLoad",e[e.Fetch=6]="Fetch",e[e.FetchEarlyLoad=268435462]="FetchEarlyLoad",e[e.OpenEnvironment=4294967295]="OpenEnvironment"}(n||(n={}));var y=t(27947),m=t(25316),v=t(10843),f=t(79070),w=t(68593),b=t(22585);class E{getFactory(e){return e.messengerFactory}}class P extends r.n{constructor(){super(...arguments),this.name="plugin",this.data=new c.C,this.allowLoad=!1,this.allowLiveReload=!0,this.pluginOverlayElements=new Map,this.applicationType=void 0,this.onResetPlugins=async({exclude:e,hard:i})=>{i&&await this.pluginConfigDataModule.reloadStoreData(!0),await this.unloadPlugins(e),await this.loadConfigured(e)},this.onLoadPlugin=async({config:e,configMeta:i,permissions:t},a)=>{var n;if(this.allowLiveReload&&a){const s={properties:i,required:[]};for(const e of Object.keys(s.properties)){(null===(n=s.properties[e].required)||void 0===n?void 0:n.includes(e))&&s.required.push(e)}if(!this.jsonSchemaValidator.validate(s,e))return;const o={applicationKey:a.applicationKey,id:a.id};if(this.data.get(o))return;await this.load(Object.assign(Object.assign(Object.assign({},a),{config:e}),t))}},this.onUnloadPlugin=async e=>{if(this.allowLiveReload&&e){const i={applicationKey:e.applicationKey,id:e.id};await this.unload(i)}},this.onReloadPlugin=async({name:e,config:i,configMeta:t,permissions:a},n)=>{this.allowLiveReload&&(await this.onUnloadPlugin(n),this.debouncedOnLoadPlugin({name:e,config:i,configMeta:t,permissions:a},n))},this.debouncedOnReloadPlugin=(0,f.s)(this.onReloadPlugin,500),this.onReloadPluginCommand=async e=>{if(!this.allowLiveReload)return;let i=this.configuredPlugins.find((i=>i.id===e.name));i||(i=this.createLoadableConfig(e.name)),this.debouncedOnReloadPlugin(e,i)},this.debouncedOnLoadPlugin=(0,f.s)(this.onLoadPlugin,500),this.onLoadPluginCommand=async e=>{this.debouncedOnLoadPlugin(e,this.createLoadableConfig(e.name))},this.debouncedOnUnloadPlugin=(0,f.s)(this.onUnloadPlugin,500),this.onUnloadPluginCommand=async e=>{let i=this.configuredPlugins.find((i=>i.id===e.name));if(!i){const t=this.availablePlugins.get(e.name);t&&(i={applicationKey:t.applicationKey,id:t.name})}this.debouncedOnUnloadPlugin(i)},this.onFetchSdkDataCommand=async e=>{const i=await this.engine.diContainer.resolve("$ServiceSdk");try{const{sdkEndpoint:t,path:a}=await this.resolveSdkEndpoint(i,e.operation);let n;n="function"==typeof t?await this.resolvePath(await t(),a):await this.handleSubscription(t,a),e.callback(n)}catch(i){throw new Error(`Failed to run command: ${e.operation}\n${null==i?void 0:i.message}`)}}}async init(e,i){if(this.jsonSchemaValidator=e.jsonSchemaValidator,this.commandBinder=i.commandBinder,[this.ses,this.sdk,this.pluginConfigDataModule,this.pluginUIData,this.settings,this.applicationData]=await Promise.all([i.getModuleBySymbol(o.JY),i.getModuleBySymbol(s.S1),i.getModuleBySymbol(o.lf),i.market.waitForData(d.kR),i.market.waitForData(m.o),i.market.waitForData(y.zH)]),this.separator=this.pluginUIData.separator,this.engine=i,this.allowLoad=e.pluginPolicies.enabled,this.allowLiveReload=this.allowLoad&&!this.pluginConfigDataModule.pluginConfigData.disabled&&!this.pluginConfigDataModule.pluginConfigData.preventLiveEdit,this.allowLoad&&(this.initializeServiceConnection(),await this.loadConfigured([],!0)),this.allowLoad){const e=i.subscribe(b.uv,(async({phase:t,application:a})=>{if(t===y.Jj.PLAYING)if(e.cancel(),this.applicationType=a,this.allowLiveReload){if(await this.loadConfigured(),!this.settings.getOverrideParam(h.L$,!1))if(this.applicationData.getName()===y.lg.WORKSHOP)await this.loadEditOnly();else{const t=i.subscribe(b.Fj,(async i=>{v.Ay.for(this).devInfo("Switch in active application detected by plugin system: ",i.application),i.application===y.lg.WORKSHOP&&(await this.loadEditOnly(),e.cancel())}));this.bindings.push(t)}}else v.Ay.for(this).devInfo("Reached PLAYING stage, checking whether configured plugins need to load to start: ",a),a===y.lg.SHOWCASE&&await this.loadConfigured(),this.bindings.push(i.subscribe(b.Fj,(async e=>{if(v.Ay.for(this).devInfo("Switch in active application detected by plugin system: ",e.application),e.application===y.lg.WORKSHOP)try{await this.disposeAll()}catch(e){v.Ay.for(this).debugWarn("Entering workshop, one or more plugins failed to dispose properly:",e)}else e.application===y.lg.SHOWCASE&&await this.loadConfigured()})))}))}this.bindings.push(i.commandBinder.addBinding(u.ho,this.onResetPlugins),i.commandBinder.addBinding(u.YB,this.onReloadPluginCommand),i.commandBinder.addBinding(u.nq,this.onLoadPluginCommand),i.commandBinder.addBinding(u.u3,this.onUnloadPluginCommand),i.commandBinder.addBinding(u.My,this.onFetchSdkDataCommand),i.commandBinder.addBinding(p.J,this.handlePluginVisibility.bind(this))),i.market.register(c.C,this.data)}initializeServiceConnection(){const e=this.pluginConfigDataModule.serviceSdkKey;this.engine.diContainer.bindAsyncFactory("$ServiceSdk",(()=>l.p.connect({connect:()=>this.sdk.connectPlugin(e,"PluginConfigRootConnection"),cancelConnecting:()=>{}},new E,window)))}async handlePluginVisibility(e){for(const i of e.ids)this.data.visibilityData.set(i,e.value),this.toggleVisibility(i,e.value)}toggleVisibility(e,i){var t;null===(t=this.pluginOverlayElements.get(e))||void 0===t||t.classList.toggle("hidden",!i),this.commandBinder.issueCommand(new w.b(e,i))}broadcastLoadEvent(e){this.engine.broadcast(new g.u(e.id,e.src,Date.now()-performance.timing.navigationStart))}async loadEditOnly(){var e,i;this.availablePlugins=this.pluginConfigDataModule.pluginConfigData.availablePlugins;const t=this.availablePlugins.values.filter((e=>{var i;return null===(i=e.options)||void 0===i?void 0:i.editOnly}));if(t.length>0){const a=t.map((e=>e.name));v.Ay.for(this).debug("Loading editOnly plugins: "+a.join(", "));const n=[];for(const a of t){const t={id:a.name,src:a.src,config:a.config,outputs:a.outputs,applicationKey:a.applicationKey,strict:a.strict,peerDependencies:a.peerDependencies,permissionLevel:a.fetchLevel,canPlaceInGrid:null===(e=a.options)||void 0===e?void 0:e.canPlaceInGrid,hideViewToggle:null===(i=a.options)||void 0===i?void 0:i.hideViewToggle};n.push(this.load(t).then((()=>{this.broadcastLoadEvent(t)})))}await Promise.all(n)}}async loadConfigured(e=[],i=!1){if(!this.pluginConfigDataModule.pluginConfigData.disabled)return this.pluginConfigDataModule.registryLoaded?void await this.updatePluginDataAndLoad(e,i):new Promise((t=>{this.registrySubscription=this.pluginConfigDataModule.registryLoadedObservable.onChanged((async a=>{a&&(await this.updatePluginDataAndLoad(e,i),t())}))}));v.Ay.for(this).debug("Cannot load plugins! Disabled by URL parameter.")}async updatePluginDataAndLoad(e,i){this.configuredPlugins=await this.pluginConfigDataModule.getConfiguredPlugins(this.applicationType,i),this.availablePlugins=this.pluginConfigDataModule.pluginConfigData.availablePlugins,this.data.visibilityData.replace(this.configuredPlugins.filter((e=>!e.hideViewToggle)).reduce(((e,i)=>{var t;return e[i.id]=null===(t=this.data.visibilityData.get(i.id))||void 0===t||t,e}),{})),v.Ay.for(this).debug("Combined configuration with registry data, loading plugins: "+JSON.stringify(this.configuredPlugins,void 0,2)),await this.waitForPluginLoad(e)}async waitForPluginLoad(e){var i;if(!this.configuredPlugins)return void v.Ay.for(this).error("Waiting for load before plugin records fetched.");const t=[];for(const e of this.configuredPlugins){const i={applicationKey:e.applicationKey,id:e.id};this.data.get(i)||t.push(this.load(e).then((()=>{this.broadcastLoadEvent(e)})))}try{await Promise.all(t)}catch(e){v.Ay.for(this).warn("Issues were encountered loading configured plugins.")}for(const t of this.pluginOverlayElements.keys()){if(e.includes(t))continue;const a=this.data.visibilityData.get(t);null===(i=this.pluginOverlayElements.get(t))||void 0===i||i.classList.toggle("hidden",!a)}}async fetchPlugin(e,i,t,a,n){a.strict&&this.ses.freezeForStrict();const s=await this.ses.makeSecureEnvironment(e+`${t?this.separator+t:""}`,i,a,this.pluginConfigDataModule.pluginConfigData.eventTarget,n);if(await(null==s?void 0:s.initialEvaluation()),s){return[s,s.compartment.globalThis.plugin]}return null}async unload(e){const i=e.id&&""!==e.id?e.id:"default",t={applicationKey:e.applicationKey,id:i},a=this.data.get(t);let n=null;if(a){try{n=a.dispose()}catch(e){v.Ay.for(this).warn("An error occurred when disposing a plugin, it may be in a partially disposed state",e)}this.data.delete(t)}return n||Promise.resolve()}async load(e){var i;const{applicationKey:t,src:s,id:o,strict:l,permissionLevel:r=n.Default,peerDependencies:d,canPlaceInGrid:c}=e;if(!this.allowLoad){const e=s.startsWith("http")?s:`${s.substring(0,16)}...`;return Promise.reject(`Load for plugin <${o}:${e}> requested, but plugin system is not available.`)}if(t.includes(this.separator))return Promise.reject(`Application Key cannot contain the separator character: ${this.separator}`);if(o.includes(this.separator))return Promise.reject(`Plugin ID cannot contain the separator character: ${this.separator}`);const h=void 0===l||l,u=o||"default",g={applicationKey:t,id:u};if(this.data.get(g))return Promise.reject(`Plugin for ${t}-${u} already loaded.`);const p={strict:h,canFetch:!!(r&a.AnyFetch),canFetchAsUser:!!(r&a.FetchAsUser),canStoreLocal:!0,canPlaceInGrid:c||!1,shadowRootMode:"closed",isFullyOpen:!!(r&a.DisableSES)},[y,m]=await this.fetchPlugin(t,s,u,p,d)||[];if(y&&m){const a=null===(i=y.overlayElement)||void 0===i?void 0:i.querySelector(`.${t}${this.separator}${o}`);a&&!e.hideViewToggle&&(this.pluginOverlayElements.set(u,a),this.data.visibilityData.set(u,!0)),await this.initPlugin(y,m.factory,e,u)}}async initPlugin(e,i,t,a){const n=i(),{applicationKey:s,id:o,config:r}=t;let d=()=>{};const c=n.onInit||n.init;let h=Promise.resolve();if(c){class e{constructor(e){this.sdk=e}connect(){return this.sdk.connectPlugin(s,o)}cancelConnecting(){}}const i=await l.p.connect(new e(this.sdk),new E,window);h=c.call(n,i,r),d=()=>i.disconnect()}const u=this.pluginConfigDataModule.pluginConfigData.eventTarget,g=this.setupVisibilityEvents(u);async function p(){const i=n.onDestroy||n.dispose;return((null==i?void 0:i.call(n))||Promise.resolve()).finally((()=>{d(),g.cancel(),u.delete(a),e.dispose()}))}const y={applicationKey:s,id:o};try{return await h,this.data.set(y,n,p),Promise.resolve()}catch(e){v.Ay.for(this).warn(`Plugin initialization failed for ${o} `,e),v.Ay.for(this).debugWarn("Attemptying dispose for clean up...");try{await p()}catch(e){v.Ay.for(this).warn("Auto-cleanup of plugin had errors: ",e)}return Promise.reject(e)}}setupVisibilityEvents(e){const i=async(e,i)=>{"_CLOSE_"===e.name&&await this.engine.commandBinder.issueCommand(new p.J([i],!1))};return e.onElementChanged({onAdded:i,onUpdated:i})}dispose(e){super.dispose(e),this.registrySubscription.cancel(),this.disposeAll().catch((e=>{v.Ay.for(this).warn("One or more plugins failed to dispose properly.",e)}))}disposeAll(){return this.configuredPlugins=[],this.unloadPlugins()}unloadPlugins(e=[]){v.Ay.for(this).devInfo("Unloading all plugins...except: "+e.join(", "));const i=[];for(const[t,a]of this.data.plugins.entries()){const n=t.split(".")[1];e.includes(n)||(i.push(a.dispose()),this.data.plugins.delete(t))}return Promise.all(i)}createLoadableConfig(e){var i,t;const a=this.availablePlugins.get(e),{src:n,config:s,applicationKey:o,strict:l,outputs:r,peerDependencies:d}=a;return{id:e,src:n,config:s,outputs:r,applicationKey:o,strict:l,peerDependencies:d,permissionLevel:a.fetchLevel,canPlaceInGrid:null===(i=a.options)||void 0===i?void 0:i.canPlaceInGrid,hideViewToggle:null===(t=a.options)||void 0===t?void 0:t.hideViewToggle}}async resolveSdkEndpoint(e,i){const[t,...a]=i.split(":"),n=t.split(".");let s="";const o=n.reduce(((e,i)=>(s=i,null==e?void 0:e[i])),e);if(!o)throw new Error(`Invalid SDK namespace or endpoint for ${i} at ${s}`);return{sdkEndpoint:o,path:a}}async handleSubscription(e,i){return new Promise(((t,a)=>{const n=e.subscribe((e=>{n.cancel();try{const a=this.resolvePath(e,i);t(a)}catch(e){a(e)}}))}))}resolvePath(e,i){for(let t=0;t<i.length;t++){const a=i[t],n="object"!=typeof e&&null!==e,s=t!==i.length-1;if(n)throw new Error(`Invalid path: ${i.join(".")} - can't index ${a} into non-object`);if(!e.hasOwnProperty(a)){if(s)throw new Error(`Invalid path: ${i.join(".")} - key "${a}" not found`);return v.Ay.for(this).debugWarn(`Invalid path: ${i.join(".")} - key "${a}" not found`),"--KeyError--"}e=e[a]}return e}}},68593:(e,i,t)=>{t.d(i,{b:()=>n});var a=t(55141);class n extends a.u{constructor(e,i){super(),this.payload={owner:e,isVisible:i}}}n.id="TOGGLE_SCENES_BY_OWNER"}}]);